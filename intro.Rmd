---
title: "Intruducción a R"
author: "Laia Egea e Iago Giné"
date: "10-12/12/2019"
abstract: "El objetivo de este curso es introducir el software R a todas las personas que trabajen con datos y darles las herramientas para el manejo y visualización de datos, así como para algunos análisis estadísticos básicos."
output: 
  html_notebook:
    toc: yes

---

# Presentación del entorno R y Rstudio

* [R](https://www.r-project.org/) y [RStudio](https://rstudio.com/) son dos programas diferentes. 
    + R es el programa que calcula. Es software libre y gratuito, inicialmente enfocado a la computación estadística.
    + R también es el lenguaje en el que escribimos los comandos, pues es también el lenguaje de programación.
    + Hoy en día está ampliamente extendido y entre los lenguajes de programación más utilizados. Como consecuencia:
        * existen muchos foros en internet donde los usuarios plantean/resuelven sus dudas y/o propuestas.
        * hay muchas librerías para R en continuo desarrollo y que permiten usarlo de una manera mucho más rápida y eficiente.
    + RStudio es la interfaz donde estaremos trabajando, pues nos ofrece algunas comodidades.
        * Nos permite crear scripts de una manera más ágil y en un entorno mucho más agradable que usando R.
        * También hace más sencillo instalar y desinstalar librerías, cargar y visualizar bases de datos, etc.
        * Ofrece otras posibilidades más allá de R como crear páginas web, pdf's o archivos word con R integrado, que va más allá de este curso.

* Entre las consecuencias de lo ampliamente usado de R está que podemos encontrar en internet muchos tutoriales introductorios en cualquier idioma:
    * [http://rosuda.org/mitarbeiter/pilhoefer/rkurs2.pdf](http://rosuda.org/mitarbeiter/pilhoefer/rkurs2.pdf)
    * [http://b2slab.upc.edu/software-and-tutorials/r-nutshell/](http://b2slab.upc.edu/software-and-tutorials/r-nutshell/)
    * [https://www.cyclismo.org/tutorial/R/index.html](https://www.cyclismo.org/tutorial/R/index.html)
    * [https://www.uv.es/vcoll/preliminares.html](https://www.uv.es/vcoll/preliminares.html)
    * [http://people.math.aau.dk/~sorenh/misc/rdocs/Rintro-notes.pdf](http://people.math.aau.dk/~sorenh/misc/rdocs/Rintro-notes.pdf)
    * en la pestaña Resources de la web de [RStudio](https://rstudio.com/)
    * [otros](https://github.com/iago-pssjd/Curso-R/archive/v1.0.zip)

* ... y foros:
    + principalmente [https://stackoverflow.com/questions/tagged/r](https://stackoverflow.com/questions/tagged/r)
    + para cuestiones relacionadas con RStudio, pero también con las librerías de la familia tidyverse y otros: [https://community.rstudio.com/](https://community.rstudio.com/)

* ... y blogs:
    + principalmente: [https://www.r-bloggers.com/](https://www.r-bloggers.com/)
    + [https://statisticsglobe.com/r-programming-language/](https://statisticsglobe.com/r-programming-language/)
    + enfocados a la estadística, pero no sólo (de hecho, diría que los siguientes son los mejores): 
        * [http://www.sthda.com/english/](http://www.sthda.com/english/)
        * [http://www.flutterbys.com.au/stats/course.html](http://www.flutterbys.com.au/stats/course.html)
        * [http://www.r-tutor.com/](http://www.r-tutor.com/sitemap)
    + enfocado a la investigación en psicología:
        * [http://personality-project.org/r/](http://personality-project.org/r/)
    + centrado en RStudio: [https://support.rstudio.com/hc/en-us](https://support.rstudio.com/hc/en-us)
    + [https://www.statmethods.net/index.html](https://www.statmethods.net/index.html)
    + [https://www.datacamp.com/community/tags/r-programming](https://www.datacamp.com/community/tags/r-programming)
    
* ... y sobre librerías o materias específicas:
    + sobre librerías en general:
        * [https://rdrr.io/](https://rdrr.io/)
        * [https://www.maths.lancs.ac.uk/~rowlings/R/TaskViews/](https://www.maths.lancs.ac.uk/~rowlings/R/TaskViews/)
    + gráficas en general:
        * [https://www.r-graph-gallery.com/](https://www.r-graph-gallery.com/)
    + formas de mostrar descriptivos:
        * [https://dabblingwithdata.wordpress.com/2018/01/02/my-favourite-r-package-for-summarising-data/](https://dabblingwithdata.wordpress.com/2018/01/02/my-favourite-r-package-for-summarising-data/)
    + neuroimagen con R:
        * [https://johnmuschelli.com/](https://johnmuschelli.com/)
    + sistemas de información geográfica (SIG)
        * ...


* ... e incluso multitud de libros que podéis encontrar en [https://bookdown.org/](https://bookdown.org/)

* ... además de diversos cursos online (MOOC's) en plataformas como Coursera, edX, etc.

* En los enlaces citados se encuentran recursos para utilizar las diferentes librerías, y también para usar R enfocado a las más diversas tareas, desde los cálculos estadísticos más habituales, pero, por ejemplo, también para hacer [meta-análisis](https://bookdown.org/MathiasHarrer/Doing_Meta_Analysis_in_R/), [análisis factorial](https://www.statmethods.net/advstats/factor.html), [estadística bayesiana o machine learning](http://www.r-tutor.com/), etc.

* También tenemos las páginas webs principales en torno a R, que también contienen información útil, pero son más técnicas:
    + [R](https://www.r-project.org/), [CRAN](https://cran.r-project.org/)
    + las publicaciones del projecto: [R News](https://www.r-project.org/doc/Rnews/index.html) (2001 - 2008) y [R Journal](https://journal.r-project.org/archive/) (2009 - presente)
    + [R Forge](https://r-forge.r-project.org/)
    + [https://stat.ethz.ch/R-manual/](https://stat.ethz.ch/R-manual/)

* Entonces, este curso, para qué?

* Y por qué R?
    + Porque puedes guardar las instrucciones que ejecutas en R scripts, y ejecutarlas todas de una vez, sin tener que memorizar y repetir cada uno de los pasos.
    + Porque en internet podrás encontrar solución a (casi) todos los problemas que tengas.
    + Porque podrás personalizar/modificar cada instrucción con las opciones que desees.
    + Porque es gratuito, como la versión de código abierto de RStudio, y los puedes instalar donde desees.
    + Porque si hay varias respuestas a una misma pregunta, lo que al principio puede hacerte dudar sobre cuál escoger, probablemente hay una que te funcionará y te irá mejor que las otras.

# Nociones elementales y funciones básicas

* R es esencialmente una consola en la que el cursor se sitúa tras el símbolo `>`. Ahí se escriben las instrucciones. Se ejecutan con `Enter`.
* Los resultados suelen aparecer debajo. En el caso de gráficas, depende del entorno en que se trabaje (R, RStudio, R Commander, etc.)
* Las instrucciones se pueden escribir todas en un fichero de texto con la extensión `.r` (el R-script), el cual puede ser cargado y ejecutado desde R. En RStudio, lo podemos ver y ejecutar al mismo tiempo en un panel situado junto al panel de la consola.
    + Desde el R-script en RStudio se ejecutan con `Control+Enter`

* Se pueden escribir comentarios (secciones de código que el programa no ejecuta), situando antes un símbolo `#`
* R es un lenguaje orientado a objetos. Para asignar nombre a los objetos usamos el símbolo `<-`
* Los objetos están compuestos de elementos y los más simples pueden ser de los siquientes tipos:
    + Lógicos
    + Numéricos
    + Caracteres


```{r, echo=TRUE}
nombre <- "Luis"
varon <- TRUE
edad <- 23
estatura <- 1.77
```
  
* Los objetos pueden ser de la siguientes clases: 
    + Vectores
    + Factores
    + Matrices
    + Data frames: `data.frame(...)`
    + Listas: `list(...)` 
    + Funciones: `function(...){...}`
    + para saber más, [Understanding basic data types in R](https://www.diegobarneche.com/2014-12-11-ufsc/lessons/01-intro_r/data-structures.html)

### Vectores

* Todos los elementos del vector han de ser del mismo tipo:
* Se crean con la función `c(...)`
* vector[X] para acceder al X-ésimo elemento del vector

```{r, echo=TRUE}
nombre <- c("Luis","Maria")
edad <- c(23,24)
varon <- c(TRUE,FALSE)
estatura <- c(1.77,1.64)

estatura[2]
```

### Factores

* Los factores pueden ser de dos tipos al igual que las variables categóricas: 
    + Nominales: No ordenados 
    + Ordinales: Ordenados
* Se crean a partir de un vector numérico con las funciones: 
    + Nominales: `as.factor()`
    + Ordinales: `as.ordered` 
* Se crean a partir de un vector de caracteres utilizando `factor()`
* Las etiquetas se asignan con `levels()`

```{r, echo=TRUE}
f <- as.factor(c(1,2,3,1,2,1,1,3,2)) #Factor Nominal
levels(f) <- c("Bajo","Medio","Alto")
ford <- as.ordered(f) #Factor Ordinal
```

### Matrices

* Las matrices son una ampliación de los vectores con dos dimensiones: filas y columnas
* Todos los elementos deben ser del mismo tipo
* Se crean con la función `matrix()`
* Para seleccionar un elemento de un matriz: Matriz[X,Y]
* Para saber las dimensiones: `dim()`


```{r, echo=TRUE}
ejema <- matrix(c(1,2,3,4,5,6,7,8,9,10,11,12), ncol=3, byrow=TRUE)
ejema

dim(ejema)

ejema[1,1]
```

### Data.frames

* Es el objeto asignado para Bases de Datos. Las filas son individuos y las columnas variables. 
* Se crean con la función `data.frame()`
* Cada columna tiene que tener los elementos del mismo tipo.
* Para seleccionar una variable: `NombreDataFrame$NombreVariable`
* Para saber la dimensión: `dim()`

```{r, echo=TRUE}
BD <- data.frame(nombre = c("Luis","Maria"), edad = c(23,24), varon = c(TRUE,FALSE), estatura = c(1.77,1.64))
BD

dim(BD)

BD$nombre

BD[1,2]
BD[1,]
BD[,2]
```



### Listas

* Una lista es un objeto consistente en una colección ordenada de objetos que se suelen llamar componentes
* No es necesario que los componentes sean del mismo tipo, ni de la misma longitud: una lista puede estar compuesta de, por ejemplo, un vector numérico de tamaño 2, un valor lógico, un vector de tamaño 3, una matriz y una función.
* Se construyen con la función `list()`
* La selección de elementos se hace con doble corchete.
* El corchete simple se utiliza para seleccionar dentro de una componente de la lista (una sublista).


```{r, echo=TRUE}
ejemplolista <- list(nombre="Pedro", casado=T,esposa="Maria", no.hijos=3, edad.hijos=c(4,7,9))
ejemplolista

ejemplolista[[5]]

ejemplolista[[5]][2]
```


```{r, echo=TRUE}


# código de R que no hace nada

x <- 4 # aisgnamos a la variable x el número 4
class(x)
is.character(4)
as.character(4) # un objeto numérico se puede coercionar a un carácter
as.numeric("a") # al revés, no
as.numeric(FALSE) # un objeto lógico se puede coercionar a uno numérico
as.numeric(TRUE)

y <- c(2:4)
y
class(y)
length(y)


floor()

```

Otras funciones prácticas para interactuar con el ordenador

```{r, echo=TRUE}

getwd()
# setwd("C:/...")
list.files()

```





## R como calculadora

```{r, echo=TRUE}

2+3
x+5
y <- x-3*7 + 24 # los espacios aquí no afectan
y

# log()
# ln()
# exp()
# log10()
# sqrt()
# factorial()


```

## Operadores aritméticos y lógicos
## Vectores y data frames 

# Funciones y librerías para interaccionar con otros softwares estadísticos como SPSS o STATA

#### ¿Se puede abrir un fichero en dta (stata) en R y cambiar su versión, por ejemplo de la 15 a la 13?

* La librería [haven](https://haven.tidyverse.org/) nos lo permite (entre las versiones 8 y 15).
* Otras librerías que pueden ayudar son: `foreign` y `readstata13`
* Para saber más, [Datasets basics](https://people.umass.edu/biep640w/pdf/R%20handout%202018%20Dataset%20Basics.pdf)

```{r, echo=TRUE}

library(haven)
dta_data <- read_dta("carsdata.dta") # con un archivo de stata 10
dta_data
str(dta_data)

# file from https://digitalcommons.usu.edu/all_datasets/27/
foreign::read.dta("Jakus_NCDA.dta") # archivo de stata 15
dta_data2 <- read_dta("Jakus_NCDA.dta")
str(dta_data2)
write_dta(dta_data2, "Jakus_NCDA2.dta", version = 13)

```



# Manejo de datos con las librerías dplyr & tidyr 

## Selección y filtro de variables 
## Transformación de variables 
## Estadísticos descriptivos 

Datos que usaremos: 

```{r, echo=TRUE}
head(iris)
?iris

library(dplyr)
data("starwars")
?starwars
head(starwars)
View(starwars)
```


* Listado de estadísticos descriptivos más habituales:

```{r, echo=TRUE}
mean(iris$Sepal.Length) # Media
sd(iris$Sepal.Length) # Desviación típica
var(iris$Sepal.Length) # Varianza
median(iris$Sepal.Length) # Mediana
min(iris$Sepal.Length) # Mínimo
max(iris$Sepal.Length) # Máximo
range(iris$Sepal.Length) # Rango
quantile(iris$Sepal.Length, probs = c(0.025, 0.975)) # Cuantiles
```

* La función `summary()` obtenemos un resumen descriptivo de una variable o bien de todas las variables de un data.frame:

```{r, echo=TRUE}
summary(iris$Sepal.Length) 
summary(iris)
```

* Para variables categóricas:

```{r, echo=TRUE}
table(iris$Species)
```

* Cuando la base de datos tiene missings: 

```{r}
mean(starwars$heigth) 
sd(starwars$heigth)

dim(starwars)
table(starwars$gender)
```


* Para arreglarlo hay que añadir `na.rm = TRUE` per funcions d'estadística descriptiva o useNA = 'always' o 'ifany'. 

```{r}
mean(starwars$heigth, na.rm = TRUE) 
sd(starwars$heigth, na.rm = TRUE) 

table(starwars$gender, useNA = 'always')
table(starwars$genders, useNA = 'ifany')
```

```{r}
table(starwars$hair_color, starwars$eye_color)
```



# Gráficos con la librería ggplot2

* `ggplot2` es una libreria que permite hacer gran variedad de gràficos "bonitos" de manera sencilla. 
* Todos los gràficos de `ggplot2` se podrían hacer también con R básico pero es más complejo. Por otro lado, ggplot2 es un poco más robusto que R básico, es decir, no te permite modificar tantas cosas dado que ya viene predeterminado.
* Las funciones que se utilizan: 
    + `ggplot()`: Crea un gràfico nuevo
    + `aes()`: Para especificar como y que variables intervendrán en todo el gràfico
    + `+`: Para añadir capas

### Gráfico de puntos

```{r}
library(ggplot2)

ggplot(SW, aes(x = mass, y = height)) + 
  geom_point()

ggplot(SW, aes(x = mass, y = height, colour = "red")) + 
  geom_point()

ggplot(SW, aes(x = mass, y = height, colour = gender)) + 
  geom_point()

ggplot(SW, aes(x = mass, y = height, colour = gender, size=birth_year, alpha = 0.5)) + 
  geom_point(shape=23)

ggplot(SW, aes(x = mass, y = height, colour = gender, fill = gender, size=birth_year, alpha = 0.5)) + 
  geom_point(shape=23)
```


# Tests estadísticos y modelos de regresión habituales para el análisis estadístico

## Tests de hipótesis

#### Prueba t de Student

* Prueba paramétrica que compara medias de dos variables (supone que son normales). 

```{r}
summary(iris)

?t.test
t.test(iris$Sepal.Length, iris$Sepal.Width, alternative = "two.sided")
t.test(iris$Sepal.Length, iris$Sepal.Width, alternative = "less")
t.test(iris$Sepal.Length, iris$Sepal.Width, alternative = "greater")

t.test(iris$Sepal.Length, iris$Sepal.Width, alternative = "two.sided", mu = 2.8)
```

#### Prueba Wilcoxon-Mann-Whitney

* Prueba no paramétrica que compara medias de dos variables

```{r}
wilcox.test(x = iris$Sepal.Length, y = iris$Sepal.Width, alternative = "two.sided", mu = 0,
            paired = FALSE, conf.int = 0.95)
```

#### Prueba de Shapiro-Wilk

* Comprueba la normalidad de una variable

```{r}
shapiro.test(starwars$height)
```

#### Prueba chi-cuadrado de Pearson 

* Prueba no paramétrica que se utiliza para probar la independencia de dos variables entre sí, mediante la presentación de los datos en tablas de contingencia.
* Hipótesis nula = independencia vs Hipotesis alternativa = dependencia

```{r}
tt <- table(starwars$gender, starwars$hair_color)
chisq.test(tt)
```

#### ANOVA

* Constituye la herramienta básica para el estudio del efecto de uno o más factores (cada uno con dos o más niveles) sobre la media de una variable continua.

```{r}
library(ggplot2)
ggplot(data = starwars, aes(x = gender, y = height, color= gender)) +
  geom_boxplot()

anova <- aov(iris$Petal.Length ~ iris$Species)
summary(anova)
```


## Regresiónes

#### Regresión Lineal simple

* $y = a+bX$

```{r}
SW <- starwars %>% 
  select(height:species) %>% 
  mutate(hair_color = as.factor(hair_color), 
         skin_color = as.factor(skin_color), 
         eye_color = as.factor(eye_color), 
         gender = as.factor(gender), 
         homeworld = as.factor(homeworld), 
         species = as.factor(species))

pairs(SW)

plot(SW$height ~ SW$mass)

mod0 <- lm(SW$height ~ SW$mass, data = iris)
summary(mod0)

mode(mod0)
mod0$coefficients

confint(object = mod0, level = 0.95 ) #Intervalo de confianza de los coeficientes de la regressión 

plot(mod0) # Diagnóstico del modelo:
```

```{r}
starwars$name[starwars$mass == 1358]

SW <- SW[-which(starwars$mass == 1358),]
plot(SW$height ~ SW$mass)

mod0_1 <- lm(SW$height ~ SW$mass, data = iris)
summary(mod0_1)

mod0_1$coefficients

confint(object = mod0_1, level = 0.95 ) #Intervalo de confianza de los coeficientes de la regressión 

plot(mod0_1) # Diagnóstico del modelo:
```


* $\text{height} = 103.5133 + 0.9327 \cdot \text{mass} $
* Podemos graficarlo:

```{r}
plot(SW$height ~ SW$mass)
abline(mod0_1)
```

* Calcular predicciones: 

```{r}
# Creamos un data.frame con los valores de la variable independiente de los que queremos hacer la predicción:
nuevas <- data.frame(mass = c(80, 60, 20))

# Calculamos las predicciones:
predict(mod0_1, nuevas)
```

#### Regresión Lineal múltiple


```{r}
mod1 <- lm(height ~ mass + gender, data = SW)
summary(mod1)
confint(object = mod1, level = 0.95 )
plot(mod1)

# Predicciones:
nuevas <- data.frame(mass = c(80, 60, 20), gender = c('male', 'female', 'female'))
predict(mod1, nuevas)
```

#### Regresión Logística
```{r}
SW$gender <- car::recode(SW$gender, "'none' = NA")
SW$gender <- factor(SW$gender)

mod2 <- glm(gender ~ height + mass + hair_color + eye_color + birth_year, data = SW, family="binomial")
summary(mod2)
plot(mod2)

exp(mod2$coefficients)
```

